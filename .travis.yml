language: cpp
dist: bionic

matrix:
  include:
    - os: linux
      dist: bionic # 18.04 LTS
      script: ".travis/linux/build.sh"
      addons:
        apt:
          update: true
          packages:
          - curl
          - libbz2-dev
          - libcurl3-openssl-dev
          - libgl1-mesa-dev
          - libglu1-mesa-dev
          - libjpeg-dev
          - liblua5.1-0-dev
          - libpng-dev
          - libsdl-mixer1.2-dev
          - libsdl-net1.2-dev
          - libsdl-ttf2.0-dev
          - libsdl1.2-dev
          - libsqlite3-dev
          - libxdg-basedir-dev
          - libxml2-dev
          - ninja-build
          - rpm
          - zlib1g-dev
      before_install:
      - ( shopt dotglob; sudo rm -rf /usr/local/cmake/* )
      - >-
          curl --retry 2 --retry-delay 30 'https://cmake.org/files/v3.13/cmake-3.13.4-Linux-x86_64.tar.gz' |
          sudo tar -xz -C /usr/local/cmake --strip-components 1

    - os: osx
      osx_image: xcode10.1 # =10.13/high sierra
      script: ".travis/macos/build.sh"
      addons:
        homebrew:
          update: true
          packages:
            - bzip2
            - cmake
            - curl
            - gettext
            - jpeg
            - libpng
            - libxml2
            - ninja
            - sdl
            - sdl_mixer
            - sdl_net
            - sdl_ttf
            - sqlite3
            - zlib
      cache:
        directories:
          - $HOME/Library/Caches/Homebrew
      before_cache:
        - brew cleanup

    - name: "Linux MXE"
      os: linux
      dist: bionic # 18.04 LTS
      script: ".travis/linux-mxe/build.sh"
      env:
      - MXE_PATH="/usr/lib/mxe"
      - MXE_HOST="x86_64-pc-linux-gnu"
      - MXE_TARGET="i686-w64-mingw32.shared"
      - PATH="$MXE_PATH/usr/bin:$PATH"
      - MXE_HOST_PFX="$MXE_PATH/usr/$MXE_HOST/bin/$MXE_TARGET"
      - MXE_CROSS_PFX="$MXE_PATH/usr/bin/$MXE_TARGET"
      - WINEARCH="win32"
      # add the MXE DLLs to Wine's path
      - WINEPATH="$MXE_PATH/usr/$MXE_TARGET/bin${WINEPATH:+:$WINEPATH}"
      before_install:
      - sudo git clone "https://github.com/mxe/mxe" "$MXE_PATH"
      - (cd "$MXE_PATH" && sudo make MXE_TARGETS="$MXE_TARGET"
          download-{bzip2,cmake,curl,gcc,gettext,jpeg,libpng,libxml2,lzma,nsis,pkgconf,sdl,sdl_mixer,sdl_net,sdl_ttf,smpeg2,sqlite,zlib})
      addons:
        apt:
          update: true
          sources:
          # for xvfb
          - sourceline: 'deb http://archive.ubuntu.com/ubuntu bionic universe'
          - sourceline: 'deb http://archive.ubuntu.com/ubuntu bionic-updates universe'
          packages:
          - ninja-build
          - wine-stable
          - wine32
          - xvfb

deploy:
  provider: releases
  api_key:
    secure: "XjHXrtaq9VSLL/zA1BKnrFNHrDuz4WUtn9JJs0EnngUt6zjw1q4Z2suVIw4iXWXkblWLIuA+HHXbM0RsiKHvc8FLFuZWpVkV/hz/AXLEZ40Yn+hW3b3z1zaNXFotXiKC+gmJcOgVo3/BQst1dG3gmUv2IM3JhYa4I3jzR9q5AqSqWbH8B1UdpB46St7D27kGdqt6tJAHZtKmyYRP7GfgeIVrCoOrhvgpFgzrj4p2yKy5voQWulXpyRyooaGOfXMzkcFzsiZLbJhLm3BaiFUOyRINufijjeDlyX5Df05a5x6uVxTZfjLFOyfzxTPpI/fMqNoYlRqvheoMVjGAu3s+e3KvllMM4hxD2M0J6WFV6beyzJqIwgR7Z3wgac5E2RJfQYo3S4V2SlKUAxqx4KXdQAiJ3VqdlE8V6p4eyoPIQFrJpsUfUye4d5rKj/U3SOD9OP9PDqNUEzzdwxYh4V0qexHJnegw4BOHIqIS+yr/fv2thJ27/mghG6a4rqxwbhANL7B3ZUVkFh6X+lW9lqsI+HQViJj7KbrFZNsg3rN6vwtfJsEPJctdvC26Dl8+A8vJWTQwPkiMJJSqliakR2P3XPuRRvHc28Q1tqytuVEJAJvF2/yGnGWauFLtI1D1yWlfMCNHnWftFUA3pXwr3DQoc7agKiBQjS+LU+Z58gGYB7o="
  file_glob: true
  file: "build/artifacts/*"
  skip_cleanup: true
  on:
    branch:
      - "release"
      - "staging"
    tags: true

